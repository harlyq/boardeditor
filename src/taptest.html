<!DOCTYPE html>
<html>

<head>
    <script src="interact.js" type="text/javascript"></script>
    <script src="layout.js" type="text/javascript"></script>
    <script src="card.js" type="text/javascript"></script>
    <script src="TweenMax.js" type="text/javascript"></script>
    <script>
    var values = {};
    var flipTimeline = null;

    var logElem = null;

    function log(msg) {
        if (!logElem)
            logElem = document.getElementById('log');

        msg += "<br/>" + logElem.innerHTML;
        logElem.innerHTML = msg.substr(0, 200);
    }

    function loadSVG(e) {
        var file = e.currentTarget.files[0];
        e.currentTarget.value = "";
        if (!file)
            return;

        var reader = new FileReader();
        var picture = null;
        reader.onloadend = function(e) {
            var svgElem = document.getElementById("svg");
            svgElem.innerHTML = reader.result;
            // if (picture) {
            //     picture.setSVG(reader.result);
            //     return;
            // }

            // picture = pictureTool.addPicture(reader.result);
            // if (reader.result.substr(0, 19) == 'data:image/svg+xml;')
            //     reader.readAsText(file); // re-read the svg
            extractRectangles(svgElem);
        }
        reader.readAsText(file);
    }

    function getBounds(points) {
        var minX = 10e10,
            minY = 10e10,
            maxX = -10e10,
            maxY = -10e10;
        for (var i = 0; i < points.length; i += 2) {
            var x = points[i],
                y = points[i + 1];
            minX = Math.min(minX, x);
            minY = Math.min(minY, y);

            maxX = Math.max(maxX, x);
            maxY = Math.max(maxY, y);
        }
        return {
            minX: minX,
            minY: minY,
            maxX: maxX,
            maxY: maxY
        };
    }

    var lineMoveRE = /^[lLmM] *(\d*\.?\d*)[ ,](\d*\.?\d*) */;
    var cornerRE = /^[cC] *(\d*\.?\d*)[ ,](\d*\.?\d*)[ ,](\d*\.?\d*)[ ,](\d*\.?\d*)[ ,](\d*\.?\d*)[ ,](\d*\.?\d*)[ ,] */;

    function extractRectangles(svgElem) {
        var paths = svgElem.querySelectorAll("path");

        [].forEach.call(paths, function(pathElem) {
            var d = pathElem.getAttribute("d"),
                lastX = 0,
                lastY = 0,
                points = [],
                processing = true;

            while (processing && d) {
                var result = d.match(lineMoveRE);
                if (result) {
                    var x = parseFloat(result[1]),
                        y = parseFloat(result[2]),
                        command = result[0][0];
                    if (command === 'm' || command === 'l') {
                        x += lastX;
                        y += lastY;
                    }
                    points.push(x, y);
                    lastX = x;
                    lastY = y;
                    d = d.substr(result[0].length);
                    continue;
                }
                result = d.match(cornerRE);
                if (result) {
                    var x1 = parseFloat(result[1]),
                        y1 = parseFloat(result[2]),
                        x2 = parseFloat(result[3]),
                        y2 = parseFloat(result[4]),
                        x = parseFloat(result[5]),
                        y = parseFloat(result[6]);
                    if (command === 'c') {
                        x1 += lastX;
                        y1 += lastY;
                        x2 += lastX;
                        y2 += lastY;
                        x += lastX;
                        y += lastY;
                    }
                    points.push(x1, y1, x2, y2, x, y);
                    lastX = x;
                    lastY = y;
                    d = d.substr(result[0].length);
                    continue;
                }
                processing = false;
            }

            var bounds = getBounds(points),
                div = document.createElement("div");

            div.style.left = bounds.minX + "px";
            div.style.top = bounds.minY + "px";
            div.style.width = bounds.maxX - bounds.minX + "px";
            div.style.height = bounds.maxY - bounds.minY + "px";
            div.classList.add("bound");
            svgElem.appendChild(div);
        });
    }

    function tweenCards(target, x, y) {
        target.style.position = 'absolute';
        // target.style.left = '0px';
        // target.style.top = '0px';

        // TweenMax.to(target, 0.25, {
        //     css: {
        //         x: x,
        //         y: y
        //     }
        // });
        TweenMax.to(target, 0.25, {
            left: ~~x,
            top: ~~y
        });
    }

    function translate(target, dx, dy, absolute) {
        target.dx = (absolute ? 0 : target.dx || 0) + dx;
        target.dy = (absolute ? 0 : target.dy || 0) + dy;

        var sTranslate = 'translate(' + target.dx + 'px, ' + target.dy + 'px)';
        target.style.transform = sTranslate;
        target.style.webkitTransform = sTranslate;
    }

    window.addEventListener("load", function(e) {
        card(".card").facedown().refresh();

        layout(".layout", {
            align: 'right',
            baseline: 'bottom',
            positionWith: tweenCards,
        });

        interact("#interact", {
                moveable: true,
                tappable: true,
                holdable: true
            })
            .doubletappable()
            .swipeable()
            .on("tap doubletap hold swipe movestart moveend move", function(e) {
                log(e.type);
            });

        interact("#dropdrag")
            .moveable(true)
            .on("move", function(e) {
                translate(e.target, e.detail.dx, e.detail.dy);
            });

        var overIndex = -2,
            indexLayout = document.getElementById("layout"),
            hand = document.getElementById("hand"),
            dragCard = null;

        // interact("#layout2 *")
        //     .moveable(true)
        //     .bubbles();

        // var dragCard = null;
        // document.querySelector("#layout2").addEventListener("move", function(e) {
        //     dragCard = e.target;
        //     translate(e.target, e.detail.dx, e.detail.dy);
        // });
        interact("#layout2>*")
            .moveable(true)
            .on("movestart", function(e) {
                dragCard = e.target; //e.detail.rawTarget;
                var rect = dragCard.getBoundingClientRect();
                hand.style.left = (rect.left + document.body.scrollLeft) + 'px';
                hand.style.top = (rect.top + document.body.scrollTop) + 'px';
                hand.appendChild(dragCard);
                dragCard.style.position = 'absolute';
                dragCard.style.left = 0;
                dragCard.style.top = 0;
                translate(hand, 0, 0, true);
            })
            .on("move", function(e) {
                translate(hand, e.detail.dx, e.detail.dy);
            });

        var placeholder = document.querySelector("#placeholder"),
            addPlaceHolder = function(e) {
                var x = e.detail.x - e.target.offsetLeft,
                    y = e.detail.y - e.target.offsetTop,
                    index = Layout.getIndex(e.target, x, y, [dragCard]);

                if (index !== overIndex) {
                    // will be null if the index was the last child
                    var replaceChild = e.currentTarget.children[index + 1];

                    if (replaceChild !== placeholder)
                        e.currentTarget.insertBefore(placeholder, replaceChild);

                    console.log(index);
                    overIndex = index;
                }
            }

        interact(".layout")
            .dropzone("#hand>*")
            .on("dropactivate", function(e) {
                e.target.classList.add('highlight');
            })
            .on("dropdeactivate", function(e) {
                e.target.classList.remove('highlight');
            })
            .on("dropenter dropover", addPlaceHolder)
            .on("drop", function(e) {
                translate(dragCard, 0, 0, true);
                if (placeholder.parentNode === e.currentTarget)
                    e.currentTarget.insertBefore(dragCard, placeholder);
            })
            .on("dropleave", function(e) {
                overIndex = -2;
                placeholder.style.position = 'relative';

                if (placeholder.parentNode === e.currentTarget)
                    document.body.appendChild(placeholder);
            });

        interact(".dropzone")
            .dropzone("#dropdrag")
            .on("drop dropover dropenter dropleave dropactivate dropdeactivate", function(e) {
                log(e.type);
            });

        document.getElementById("loadSVG").addEventListener("change", loadSVG);

        document.getElementById("tap").addEventListener("click", function(e) {
            // toggle
            values.tapped = !values.tapped;
            TweenMax.to(e.currentTarget, 0.25, {
                css: {
                    rotation: (values.tapped ? 90 : 0)
                }
            });
        });

        document.getElementById("flip").addEventListener("click", function(e) {
            // toggle
            if (flipTimeline) {
                flipTimeline.reversed(!flipTimeline.reversed());
            } else {
                flipTimeline = new TimelineMax()
                    .to(e.currentTarget, 0.125, {
                        css: {
                            rotationY: 90
                        },
                        onComplete: function() {
                            e.currentTarget.classList.add("facedown");
                        }
                    })
                    .to(e.currentTarget, 0.125, {
                        css: {
                            rotationY: 180
                        },
                        onReverseComplete: function() {
                            e.currentTarget.classList.remove("facedown");
                        }
                    });
            }
        });

        document.getElementById("zoom").addEventListener("click", function(e) {
            // toggle
            values.zoomed = !values.zoomed;
            TweenMax.to(e.currentTarget, 0.25, {
                css: {
                    scale: (values.zoomed ? 1.75 : 1)
                }
            })
        });

        var dragElem = document.getElementById("drag"),
            oldX, oldY;
        values.dx = 0;
        values.dy = 0;

        var dragDown = function(e) {
            e.preventDefault();
            oldX = e.clientX - values.dx;
            oldY = e.clientY - values.dy;
            document.addEventListener("mousemove", dragMove);
            document.addEventListener("mouseup", dragUp);
        };
        var dragMove = function(e) {
            e.preventDefault();
            values.dx = e.clientX - oldX;
            values.dy = e.clientY - oldY;
            dragElem.style.transform = "translate(" + values.dx + "px, " + values.dy + "px)";
        };
        var dragUp = function(e) {
            e.preventDefault();
            document.removeEventListener("mousemove", dragMove);
            document.removeEventListener("mouseup", dragUp);
        }

        dragElem.addEventListener("mousedown", dragDown);
        values.picked = [];

        var pickClick = function(e) {
            e.preventDefault();

            // toggle
            var i = values.picked.indexOf(e.currentTarget);
            if (i === -1)
                values.picked.push(e.currentTarget);
            else
                values.picked.splice(i, 1);

            TweenMax.to(e.currentTarget, 0.25, {
                css: {
                    y: (i === -1 ? 20 : 0)
                }
            });
        };

        document.getElementById("pick1").addEventListener("click", pickClick);
        document.getElementById("pick2").addEventListener("click", pickClick);
        document.getElementById("pick3").addEventListener("click", pickClick);
    });
    </script>

    <style>
    .card {
        padding: 5px;
        /*margin: 20px;*/
        
        width: 100px;
        height: 140px;
        outline: 1px solid red;
        cursor: pointer;
        text-align: center;
        line-height: 140px;
        color: red;
        display: inline-block;
        background-color: white;
        user-select: none;
        -webkit-user-select: none;
    }
    .facedown {
        background-color: lightBlue;
    }
    .bound {
        position: absolute;
        outline: 2px solid red;
    }
    .layout {
        position: relative;
        width: 500px;
        height: 250px;
        outline: 1px solid green;
        padding: 20px;
    }
    #svg {
        display: inline-block;
        position: relative;
    }
    #placeholder {
        background-color: red;
    }
    .layout.highlight {
        outline: 3px solid purple;
    }
    #hand {
        position: absolute;
    }
    body {
        position: relative;
    }
    .cutout {
        outline: 1px dashed blue;
    }
    </style>
</head>

<body>
    <input id="loadSVG" type="file"></input>
    <div id="svg"></div>
    <div></div>
    <div id="tap" class="card">TAP</div>
    <div id="flip" class="card">FLIP</div>
    <div id="zoom" class="card">ZOOM</div>
    <div id="drag" class="card">DRAG</div>
    <div id="layout" class="layout" baseline="middle" offset="-50">
        <div id="pick1" class="card">PICK</div>
        <div id="pick2" class="card">PICK</div>
        <div id="pick3" class="card">PICK</div>
    </div>
    <div id="layout2" class="layout" layout="fan" align="left" offsetx="-30" offsety="3" baseline="middle">
        <div class="card">CARD 1</div>
        <div class="card">CARD 2</div>
        <div class="card">CARD 3</div>
        <div class="card">CARD 4</div>
    </div>
    <div id="interact" class="card" front="#c1" back="#c2" facedown="false">INTERACT</div>
    <div id="dropdrag" class="card">DROPDRAG</div>
    <div class="dropzone card">DROPZONE</div>
    <div class="dropzone card">DROPZONE 2</div>
    <div id="log"></div>
    <div id="placeholder" class="card"></div>
    <div id="hand"></div>
    <div style="position: relative">
        <img src="derelect house.jpg"></img>
        <div id="c1" class="cutout" style="position: absolute; left: 20px; top: 20px; width: 100px; height: 100px"></div>
        <div id="c2" class="cutout" style="position: absolute; left: 280px; top: 220px; width: 50px; height: 50px"></div>
    </div>
    <!--img src="Love Letter.svg" alt="boardgame picture"-->
</body>

</html>
