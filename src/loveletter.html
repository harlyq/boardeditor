<!DOCTYPE html>
<html>

<head>
    <script src="interact.js" type="text/javascript"></script>
    <script src="layout.js" type="text/javascript"></script>
    <script src="card.js" type="text/javascript"></script>
    <script src="TweenMax.js" type="text/javascript"></script>

    <style>
    #board {
        position: relative;
        width: 600px;
        height: 400px;
    }
    #pieces {
        position: relative;
        width: 0px;
        height: 0px;
        opacity: 0;
        /* display:none; hides everything, use opactiy: 0; instead */
    }
    .layout {
        outline: 3px solid grey;
        position: absolute;
    }
    .cutout {
        outline: 3px dashed red;
        position: absolute;
    }
    .card {
        position: absolute;
        width: 100px;
        height: 140px;
    }
    .layout.highlight {
        outline: 3px solid red;
    }
    </style>

    <script type="text/javascript">
    var logElem = null;
    var log = function(msg) {
        if (!logElem) {
            logElem = document.getElementById('log');
            if (!logElem)
                return;
        }

        msg += "<br/>" + logElem.innerHTML;
        logElem.innerHTML = msg.substr(0, 1000);
    }

    var transformStyle = 'transform';

    function translate(target, dx, dy, absolute) {
        target['dx'] = (absolute ? 0 : target['dx'] || 0) + dx;
        target['dy'] = (absolute ? 0 : target['dy'] || 0) + dy;

        var sTranslate = 'translate(' + target['dx'] + 'px, ' + target['dy'] + 'px)';

        target.style[transformStyle] = sTranslate;
    }

    var zoomTarget = null;
    var cards = null;
    var layouts = null;

    function toggleZoom(target) {
        if (zoomTarget) {
            zoomTarget.style[transformStyle] = 'scale(1.0, 1.0)';
            zoomTarget.style.zIndex = "0";
            cards.refresh(zoomTarget);
        }

        if (zoomTarget === target) {
            zoomTarget = null; // toggle
            return;
        }

        zoomTarget = target;

        if (zoomTarget) {
            zoomTarget.style[transformStyle] = 'scale(2.0, 2.0)';
            target.style.zIndex = "1";
            cards.refresh(zoomTarget);
        }
    }

    window.addEventListener("load", function() {
        var style = document.getElementById('board').style;
        if ('transform' in style)
            transformStyle = 'transform';
        else if ('webkitTransform' in style)
            transformStyle = 'webkitTransform';

        cards = card(".card").facedown().refresh();
        layouts = layout(".layout");

        interact(".card")
            .debug()
            .doubletappable()
            .on("doubletap", function(e) {
                toggleZoom(e.currentTarget);
            });

        var moving = [];
        interact("#discard > .card", {
                debug: false
            })
            .moveable()
            .on("move", function(e) {
                e.currentTarget.style.zIndex = '1';
                translate(e.currentTarget, e.detail.dx, e.detail.dy);
                toggleZoom(null);

                var i = moving.indexOf(e.currentTarget);
                if (i === -1)
                    moving.push(e.currentTarget);
            })
            .on("moveend", function(e) {
                var i = moving.indexOf(e.currentTarget);
                if (i !== -1) {
                    moving.splice(i, 1);
                    translate(e.currentTarget, 0, 0, true);
                    e.currentTarget.style.zIndex = '';
                }
            })

        interact("#hand")
            .dropzone(".card")
            .on("dropactivate", function(e) {
                e.currentTarget.classList.add('highlight');
            })
            .on("dropdeactivate", function(e) {
                e.currentTarget.classList.remove('highlight')
            })
            .on("drop", function(e) {
                var dragCard = e.detail.dragTarget;
                e.currentTarget.appendChild(dragCard);
                dragCard.setAttribute('facedown', 'false');
            })

        // setup
        var elements = cards.getElements();
        var discard = document.querySelector("#discard");
        for (var i = 0; i < elements.length; ++i)
            discard.appendChild(elements[i]);

    });
    </script>
</head>

<body>
    <div id="board">
        <div id="discard" class="layout" layout="stack" style="left: 10px; top: 10px; width: 100px; height: 140px; padding: 10px"></div>
        <div id="hand" class="layout" layout="fan" style="left: 200px; top: 10px; width: 500px; height: 140px; padding: 10px"></div>
        <div id="c1" class="card" front="#f1" back="#back"></div>
        <div id="c2" class="card" front="#f1" back="#back"></div>
        <div id="c3" class="card" front="#f1" back="#back"></div>
        <div id="c4" class="card" front="#f1" back="#back"></div>
        <div id="c5" class="card" front="#f1" back="#back"></div>
        <div id="c6" class="card" front="#f2" back="#back"></div>
        <div id="c7" class="card" front="#f2" back="#back"></div>
        <div id="c8" class="card" front="#f3" back="#back"></div>
        <div id="c9" class="card" front="#f3" back="#back"></div>
        <div id="c10" class="card" front="#f4" back="#back"></div>
        <div id="c11" class="card" front="#f4" back="#back"></div>
        <div id="c12" class="card" front="#f5" back="#back"></div>
        <div id="c13" class="card" front="#f5" back="#back"></div>
        <div id="c14" class="card" front="#f6" back="#back"></div>
        <div id="c15" class="card" front="#f7" back="#back"></div>
        <div id="c16" class="card" front="#f8" back="#back"></div>
    </div>
    <div id="pieces">
        <img src="Love-Letter-Cards.jpg"></img>
        <div id="f1" class="cutout" style="width:205px; height:288px; top: 30px; left: 34px"></div>
        <div id="f2" class="cutout" style="width:205px; height:288px; top: 30px; left: 267px"></div>
        <div id="f3" class="cutout" style="width:205px; height:288px; top: 33px; left: 495px"></div>
        <div id="f4" class="cutout" style="width:205px; height:288px; top: 350px; left: 34px"></div>
        <div id="f5" class="cutout" style="width:205px; height:288px; top: 352px; left: 267px"></div>
        <div id="f6" class="cutout" style="width:205px; height:288px; top: 356px; left: 500px"></div>
        <div id="f7" class="cutout" style="width:205px; height:288px; top: 672px; left: 34px"></div>
        <div id="f8" class="cutout" style="width:205px; height:288px; top: 675px; left: 267px"></div>
        <div id="back" class="cutout" style="width:205px; height:288px; top: 676px; left: 501px"></div>
    </div>
    <div id="log"></div>
</body>

</html>
